<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Web</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            height: 100%;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 70px; /* Space for input area */
        }
        .message {
            margin-bottom: 16px;
            padding: 10px 14px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .user-message {
            background-color: transparent;
            border: 2px solid #cccccc;
            align-self: flex-end;
            margin-left: auto;
            margin-right: 0;
            text-align: right;
            min-width: 30%;
            max-width: 80%;
        }
        .bot-message {
            background-color: transparent;
            border: 1px solid #cccccc;
            align-self: flex-start;
            max-width: 100%;
        }
        .input-area {
            display: flex;
            padding: 10px;
            background-color: #f0f0f0;
            border-top: 1px solid #ddd;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        #message-input {
            flex: 1;
            min-width: 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        #send-button {
            flex-shrink: 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #history-button {
            flex-shrink: 0;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #input-history-button {
            flex-shrink: 0;
            background-color: #9C27B0;
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            margin-left: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #send-button:active, #history-button:active, #input-history-button:active {
            opacity: 0.8;
        }
        /* Icons styling */
        .icon {
            width: 24px;
            height: 24px;
            fill: white;
        }
        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        code {
            font-family: monospace;
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
        }
        blockquote {
            border-left: 4px solid #ddd;
            padding-left: 10px;
            color: #666;
            margin-left: 0;
        }
        .typing-indicator {
            display: none;
            padding: 10px;
            background-color: #f1f1f1;
            border-radius: 18px;
            margin-bottom: 16px;
            position: fixed;
            bottom: 60px;
            left: 16px;
            z-index: 10;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #888;
            border-radius: 50%;
            display: inline-block;
            margin: 0 1px;
            animation: bounce 1.2s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        table {
          border-collapse: collapse;
          border: 1px solid #cccccc;
        }
        th, td {
          border: 1px solid #cccccc;
        }
        del {
            text-decoration: none !important;  /* Remove strikethrough and make it important */
        }
        /* Session history panel styles */
        .session-panel {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background-color: white;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 8px rgba(0,0,0,0.1);
            z-index: 1000;
            flex-direction: column;
        }
        .panel-header {
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-title {
            font-weight: bold;
            font-size: 16px;
        }
        .panel-controls {
            display: flex;
            gap: 10px;
        }
        .control-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 12px;
        }
        .control-btn:hover {
            background-color: #f0f0f0;
        }
        .close-panel {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }
        .sessions-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .session-item {
            margin-bottom: 10px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .session-item:hover {
            background-color: #f8f9fa;
        }
        .session-item.active {
            background-color: #e3f2fd;
            border-color: #2196F3;
        }
        .session-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 4px;
            line-height: 1.3;
        }
        .session-meta {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }
        .session-preview {
            font-size: 12px;
            color: #888;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .session-web-info {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .web-icon {
            font-size: 10px;
        }
        .web-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }
        .session-actions {
            display: none;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #eee;
        }
        .session-item:hover .session-actions {
            display: block;
        }
        .session-action-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 3px 6px;
            margin-right: 5px;
            cursor: pointer;
            font-size: 10px;
        }
        .session-action-btn.delete {
            color: #d32f2f;
            border-color: #d32f2f;
        }
        .session-action-btn:hover {
            background-color: #f0f0f0;
        }
        .empty-sessions {
            text-align: center;
            color: #888;
            font-style: italic;
            margin-top: 50px;
        }
        @media (max-width: 600px) {
            .session-panel {
                width: 100%;
                left: 0;
            }
        }
        /* Input history popup styles */
        .input-history-popup {
            display: none;
            position: fixed;
            bottom: 70px;
            left: 10px;
            right: 10px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }
        .input-history-header {
            padding: 10px 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .input-history-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .input-history-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            line-height: 1.4;
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .input-history-item:hover {
            background-color: #f5f5f5;
        }
        .input-history-text {
            flex: 1;
        }
        .input-arrow-btn {
            flex-shrink: 0;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            margin-left: 10px;
        }
        .input-arrow-btn:hover {
            background-color: #e0e0e0;
        }
        .arrow-icon {
            width: 16px;
            height: 16px;
            fill: #666;
        }
        .input-history-item:last-child {
            border-bottom: none;
        }
        .input-history-empty {
            padding: 20px;
            text-align: center;
            color: #888;
            font-style: italic;
        }
        .close-input-history {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 5px;
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-messages" id="chat-messages">
    </div>
    <div class="typing-indicator" id="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="input-area">
        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
        <button id="send-button">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
        <button id="input-history-button">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11.5,7H12.5V13L16.5,15.5L17.5,14.08L13.5,11.5V7H11.5Z"/>
            </svg>
        </button>
        <button id="history-button">
            <svg class="icon" viewBox="0 0 24 24">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
            </svg>
        </button>
    </div>
</div>

<!-- Session History Panel -->
<div class="session-panel" id="session-panel">
    <div class="panel-header">
        <span class="panel-title">Chat Sessions</span>
        <!-- keep buttons spacing larger -->
        <div class="panel-controls">
            <button class="control-btn" id="clear-all-btn">Clear All</button>
            <div></div>
            <button class="close-panel" id="close-panel">&nbsp;&times;&nbsp;</button>
        </div>
    </div>
    <div class="sessions-container" id="sessions-container">
        <!-- Session items will be inserted here -->
    </div>
</div>

<!-- Input History Popup -->
<div class="input-history-popup" id="input-history-popup">
    <div class="input-history-header">
        <span>Input History</span>
        <button class="close-input-history" id="close-input-history">&times;</button>
    </div>
    <ul class="input-history-list" id="input-history-list">
        <!-- Input history items will be inserted here -->
    </ul>
</div>

<!-- Include marked.js for Markdown parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>

<script>
    // Global variables
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const inputHistoryButton = document.getElementById('input-history-button');
    const typingIndicator = document.getElementById('typing-indicator');
    const historyButton = document.getElementById('history-button');
    const sessionPanel = document.getElementById('session-panel');
    const sessionsContainer = document.getElementById('sessions-container');
    const closePanel = document.getElementById('close-panel');
    const clearAllBtn = document.getElementById('clear-all-btn');
    const inputHistoryPopup = document.getElementById('input-history-popup');
    const inputHistoryList = document.getElementById('input-history-list');
    const closeInputHistory = document.getElementById('close-input-history');

    // Track current message element for streaming
    let currentStreamMessageElement = null;
    let isStreaming = false;

    // Session management
    const SESSIONS_KEY = 'chatSessions';
    const CURRENT_SESSION_KEY = 'currentSessionId';
    const INPUT_HISTORY_KEY = 'chatInputHistory';
    const MAX_SESSIONS = 50;
    const MAX_INPUT_HISTORY = 8;
    
    // Current session state
    let currentSessionId = null;
    let sessions = {};
    let currentMessages = [];
    let webMetadata = { title: '', url: '' };
    let inputHistory = [];

    // Input history management
    function loadInputHistory() {
        try {
            const savedHistory = localStorage.getItem(INPUT_HISTORY_KEY);
            if (savedHistory) {
                inputHistory = JSON.parse(savedHistory);
            }
        } catch (error) {
            console.warn('Failed to load input history:', error);
            inputHistory = [];
        }
    }

    function saveInputHistory() {
        try {
            localStorage.setItem(INPUT_HISTORY_KEY, JSON.stringify(inputHistory));
        } catch (error) {
            console.warn('Failed to save input history:', error);
        }
    }

    function addToInputHistory(input) {
        if (!input || input.trim() === '') return;
        
        const trimmedInput = input.trim();
        
        // Remove existing instance of this input
        inputHistory = inputHistory.filter(item => item !== trimmedInput);
        
        // Add to beginning of array
        inputHistory.unshift(trimmedInput);
        
        // Keep only the last MAX_INPUT_HISTORY items
        if (inputHistory.length > MAX_INPUT_HISTORY) {
            inputHistory = inputHistory.slice(0, MAX_INPUT_HISTORY);
        }
        
        saveInputHistory();
    }

    function showInputHistoryPopup() {
        try {
            populateInputHistoryList();
            inputHistoryPopup.style.display = 'block';
        } catch (error) {
            console.error('Error showing input history popup:', error);
        }
    }

    function hideInputHistoryPopup() {
        try {
            inputHistoryPopup.style.display = 'none';
        } catch (error) {
            console.error('Error hiding input history popup:', error);
        }
    }

    function populateInputHistoryList() {
        try {
            inputHistoryList.innerHTML = '';
            
            if (inputHistory.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'input-history-empty';
                emptyDiv.textContent = 'No input history yet';
                inputHistoryList.appendChild(emptyDiv);
                return;
            }
            
            inputHistory.forEach(input => {
                const li = document.createElement('li');
                li.className = 'input-history-item';
                
                const textSpan = document.createElement('span');
                textSpan.className = 'input-history-text';
                textSpan.textContent = input;
                
                const arrowBtn = document.createElement('button');
                arrowBtn.className = 'input-arrow-btn';
                arrowBtn.innerHTML = `
                    <svg class="arrow-icon" viewBox="0 0 24 24">
                        <path d="M12 16l-4-4h3V4h2v8h3l-4 4z"/>
                    </svg>
                `;

                // Arrow button click - fill input without keyboard
                arrowBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    messageInput.value = input;
                    hideInputHistoryPopup();
                    // Don't focus to avoid keyboard popup
                });
                
                // Main item click - send message directly
                li.addEventListener('click', function(e) {
                    if (e.target === arrowBtn || arrowBtn.contains(e.target)) {
                        return; // Let arrow button handle its own click
                    }
                    sendMessageToAndroid(input);
                    hideInputHistoryPopup();
                });
                
                li.appendChild(textSpan);
                li.appendChild(arrowBtn);
                inputHistoryList.appendChild(li);
            });
        } catch (error) {
            console.error('Error populating input history list:', error);
        }
    }

    // Function to get web metadata with retry
    function getWebMetadata(callback) {
        function tryGetMetadata(attempts = 0) {
            if (window.AndroidInterface && typeof window.AndroidInterface.getWebMetadata === 'function') {
                try {
                    const metadataJson = window.AndroidInterface.getWebMetadata();
                    const metadata = JSON.parse(metadataJson);
                    console.log('Web metadata loaded:', metadata);
                    webMetadata = metadata;
                    callback(metadata);
                    return;
                } catch (e) {
                    console.warn('Failed to get web metadata, attempt', attempts + 1, ':', e);
                }
            }
            
            if (attempts < 5) {
                setTimeout(() => tryGetMetadata(attempts + 1), 100);
            } else {
                console.warn('Failed to get web metadata after 5 attempts');
                callback({ title: '', url: '' });
            }
        }
        
        tryGetMetadata();
    }

    // Initialize sessions from localStorage
    function initializeSessions() {
        try {
            // Load existing sessions and input history
            const savedSessions = localStorage.getItem(SESSIONS_KEY);
            if (savedSessions) {
                sessions = JSON.parse(savedSessions);
            }
            
            loadInputHistory();
            
            // Get web metadata and then create new session
            getWebMetadata((metadata) => {
                webMetadata = metadata;
                createNewSession();
            });
        } catch (error) {
            console.warn('Failed to load sessions from localStorage:', error);
            createNewSession();
        }
    }

    // Generate session title from first user message
    function generateSessionTitle(firstMessage) {
        if (!firstMessage) return 'New Chat';
        return firstMessage.length > 40 ? firstMessage.substring(0, 40) + '...' : firstMessage;
    }

    // Save sessions to localStorage
    function saveSessions() {
        try {
            if (currentSessionId && sessions[currentSessionId]) {
                sessions[currentSessionId].messages = [...currentMessages];
            }
            
            localStorage.setItem(SESSIONS_KEY, JSON.stringify(sessions));
            if (currentSessionId) {
                localStorage.setItem(CURRENT_SESSION_KEY, currentSessionId);
            }
        } catch (error) {
            console.error('Failed to save sessions:', error);
        }
    }

    // Create new session
    function createNewSession() {
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
        
        // Use web metadata for the session title if available, otherwise use 'New Chat'
        const sessionTitle = (webMetadata.title && webMetadata.title.trim() !== '') 
            ? webMetadata.title 
            : 'New Chat';
        
        sessions[sessionId] = {
            id: sessionId,
            title: sessionTitle,
            created: Date.now(),
            lastUpdated: Date.now(),
            messages: [],
            webTitle: webMetadata.title || '',
            webUrl: webMetadata.url || ''
        };
        
        console.log('Created new session:', sessions[sessionId]);
        
        // Clean up old sessions if we have too many
        const sessionIds = Object.keys(sessions);
        if (sessionIds.length > MAX_SESSIONS) {
            // Sort by lastUpdated and remove oldest
            const sortedSessions = sessionIds.sort((a, b) => 
                sessions[b].lastUpdated - sessions[a].lastUpdated
            );
            
            for (let i = MAX_SESSIONS; i < sortedSessions.length; i++) {
                delete sessions[sortedSessions[i]];
            }
        }
        
        switchToSession(sessionId);
        return sessionId;
    }

    // Switch to a different session
    function switchToSession(sessionId) {
        if (!sessions[sessionId]) return;
        
        // Save current session before switching
        if (currentSessionId && sessions[currentSessionId]) {
            if (currentMessages.length > 0) {
                sessions[currentSessionId].messages = [...currentMessages];
            } else {
                // If no messages, delete the session from sessions
                delete sessions[currentSessionId];
            }
        }
        
        currentSessionId = sessionId;
        loadSession(sessionId);
        updateSessionPanel();
        saveSessions();
    }

    // Load session messages
    function loadSession(sessionId) {
        if (!sessions[sessionId]) return;
        
        const session = sessions[sessionId];
        currentMessages = [...session.messages];
        
        // Clear chat and reload messages
        chatMessages.innerHTML = '';
        
        currentMessages.forEach(msg => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.isUser ? 'user-message' : 'bot-message'}`;
            
            if (msg.isUser) {
                messageDiv.textContent = msg.content;
            } else {
                messageDiv.innerHTML = marked.parse(msg.content);
            }
            
            chatMessages.appendChild(messageDiv);
        });
        
        scrollToBottom();
    }

    // Delete session
    function deleteSession(sessionId) {
        if (!sessions[sessionId]) return;
        
        delete sessions[sessionId];
        
        // If we deleted the current session, load first session in sessions; if empty, create a new one
        const sessionIds = Object.keys(sessions);
        if (sessionIds.length === 0) {
            currentSessionId = null;
            currentMessages = [];
            createNewSession();
        } else {
            currentSessionId = sessionIds[0];
            loadSession(currentSessionId);
        }
        updateSessionPanel();
        saveSessions();
    }

    // Clear all sessions
    function clearAllSessions() {
        if (confirm('Are you sure you want to delete all chat sessions? This cannot be undone.')) {
            sessions = {};
            currentSessionId = null;
            currentMessages = [];
            createNewSession();
            updateSessionPanel();
        }
    }

    // Add message to current session
    function addMessageToSession(content, isUser = false) {
        const message = {
            content: content,
            isUser: isUser,
            timestamp: Date.now()
        };
        
        currentMessages.push(message);
        
        // Update session title if this is the first user message and we only have 'New Chat' as title
        // Don't override if we already have a web title
        if (isUser && sessions[currentSessionId] && 
            sessions[currentSessionId].title === 'New Chat' && 
            !sessions[currentSessionId].webTitle) {
            sessions[currentSessionId].title = generateSessionTitle(content);
            updateSessionPanel();
        }
        
        saveSessions();
        return message;
    }

    // Update session panel
    function updateSessionPanel() {
        try {
            sessionsContainer.innerHTML = '';
            
            const sessionIds = Object.keys(sessions).sort((a, b) => 
                sessions[b].lastUpdated - sessions[a].lastUpdated
            );
            
            if (sessionIds.length === 0) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'empty-sessions';
                emptyDiv.textContent = 'No chat sessions yet';
                sessionsContainer.appendChild(emptyDiv);
                return;
            }
            
            sessionIds.forEach(sessionId => {
                const session = sessions[sessionId];
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'session-item';
                if (sessionId === currentSessionId) {
                    sessionDiv.classList.add('active');
                }
                
                // Get preview text from first few messages
                let preview = 'No messages';
                if (session.messages && session.messages.length > 0) {
                    const firstMessage = session.messages.find(m => m.isUser);
                    if (firstMessage) {
                        preview = firstMessage.content.length > 60 ? 
                            firstMessage.content.substring(0, 60) + '...' : 
                            firstMessage.content;
                    }
                }
                
                const lastUpdated = new Date(session.lastUpdated).toLocaleDateString();
                const messageCount = session.messages.length;
                const hasWebUrl = session.webUrl && session.webUrl.trim() !== '';
                
                console.log(`Session ${sessionId}: webUrl="${session.webUrl}", webTitle="${session.webTitle}", hasWebUrl=${hasWebUrl}`);
                
                let sessionHtml = `
                    <div class="session-title">${session.title}</div>
                    <div class="session-meta">${lastUpdated} • ${messageCount} messages</div>`;
                
                if (hasWebUrl) {
                    sessionHtml += `
                        <div class="session-web-info">
                            <span class="web-icon">🔗</span>
                            <span class="web-title">${session.webTitle || 'Web Page'}</span>
                        </div>`;
                }
                
                sessionHtml += `
                    <div class="session-preview">${preview}</div>
                    <div class="session-actions">
                        <button class="session-action-btn" onclick="switchToSession('${sessionId}'); hideSessionPanel();">Load</button>`;
                
                if (hasWebUrl) {
                    sessionHtml += `
                        <button class="session-action-btn" onclick="openOriginalUrl('${escapeHtml(session.webUrl)}')">Open URL</button>`;
                }
                
                sessionHtml += `
                        <button class="session-action-btn delete" onclick="deleteSession('${sessionId}')">Delete</button>
                    </div>
                `;
                
                sessionDiv.innerHTML = sessionHtml;
                
                // Add click event to load session
                sessionDiv.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('session-action-btn')) {
                        switchToSession(sessionId);
                        hideSessionPanel();
                    }
                });
                
                sessionsContainer.appendChild(sessionDiv);
            });
        } catch (error) {
            console.error('Error updating session panel:', error);
        }
    }

    // Show/hide session panel
    function showSessionPanel() {
        try {
            updateSessionPanel();
            sessionPanel.style.display = 'flex';
        } catch (error) {
            console.error('Error showing session panel:', error);
        }
    }

    function hideSessionPanel() {
        try {
            sessionPanel.style.display = 'none';
        } catch (error) {
            console.error('Error hiding session panel:', error);
        }
    }

    // Make sure document has proper height for scrolling
    document.addEventListener('DOMContentLoaded', function() {
        adjustLayout();
    });

    // Handle window resize
    window.addEventListener('resize', function() {
        adjustLayout();
    });

    // Adjust layout for proper scrolling
    function adjustLayout() {
        // Ensure the input is visible
        messageInput.scrollIntoView(false);

        // Notify Android of height changes
        if (window.AndroidInterface && typeof window.AndroidInterface.onContentHeightChanged === 'function') {
            window.AndroidInterface.onContentHeightChanged(document.body.scrollHeight);
        }
    }

    // Configuration for Markdown parsing
    marked.setOptions({
        breaks: true, // Add line breaks as paragraphs
        gfm: true     // Enable GitHub Flavored Markdown
    });
    marked.use({
        extensions: [],
        options: {
            gfm: false,
            strikethrough: false
        },
        tokenizer: {
            del(src) {
              // Return false to prevent strikethrough parsing
              return false;
            }
        },
        renderer: {
            strikethrough: () => false
        }

    });

    // Function to add a message to the chat
    function addMessage(text, isUser = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;

        // Add to session
        addMessageToSession(text, isUser);

        // If it's a user message, just add the text
        if (isUser) {
            messageDiv.textContent = text;
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        } else {
            // For bot messages, we'll handle them separately
            // since they could be streamed or complete
            messageDiv.innerHTML = ''; // Start empty for streaming
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
            // Return the element for potential streaming updates
            return messageDiv;
        }
        console.log('addMessage:', text, isUser);
    }

    let streamText = ''; // Placeholder for streaming text
    // Function to handle streaming updates to a message
    function updateStreamMessage(element, text, isComplete = false) {
        console.log('update Streaming:', text);
        if (!element) {
            currentStreamMessageElement = addMessage('', false);
            element = currentStreamMessageElement;
        }

        if (isComplete) {
            // If it's the final update, render the complete markdown
            const completeText = streamText + text;
            element.innerHTML = marked.parse(completeText);
            
            // Update the session with the complete message
            if (currentMessages.length > 0) {
                const lastMessage = currentMessages[currentMessages.length - 1];
                if (!lastMessage.isUser) {
                    lastMessage.content = completeText;
                    saveSessions();
                }
            }
            
            // Reset streaming state
            isStreaming = false;
            streamText = '';
            currentStreamMessageElement = null;
            console.log('isComplete == true');
        } else {
            // For partial updates, just show the raw text as it comes in
            streamText += text;
            element.innerHTML = marked.parse(streamText);
            console.log('Streaming:', streamText);
        }

        //scrollToBottom();
    }

    // Function to receive messages from Android - supports streaming
    function receiveMessageFromAndroid(markdown, isStream = false, isComplete = false) {
        console.log('receiveMessageFromAndroid:', markdown, isStream, isComplete);
        hideTypingIndicator();

        if (isStream) {
            updateStreamMessage(currentStreamMessageElement, markdown, isComplete);
        } else {
            const messageDiv = addMessage('', false);
            messageDiv.innerHTML = marked.parse(markdown);
            //scrollToBottom();
        }
    }

    // Function to handle stream start
    function startMessageStream() {
        console.log('startMessageStream');
        isStreaming = true;
        currentStreamMessageElement = addMessage('', false);
    }

    // Function to scroll to bottom (compatible with WebView.scrollBy)
    function scrollToBottom() {
        // Use setTimeout to ensure this happens after DOM updates
        setTimeout(() => {
            // This calculates total scroll height and scrolls there
            const scrollHeight = chatMessages.scrollHeight;
            window.scrollTo(0, document.body.scrollHeight);

            // Make this visible to Android
            if (window.AndroidInterface && typeof window.AndroidInterface.onContentHeightChanged === 'function') {
                window.AndroidInterface.onContentHeightChanged(document.body.scrollHeight);
            }
        }, 100);
    }

    // Function to show typing indicator
    function showTypingIndicator() {
        typingIndicator.style.display = 'block';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to hide typing indicator
    function hideTypingIndicator() {
        typingIndicator.style.display = 'none';
    }

    // Function to send a message to Android
    function sendMessageToAndroid(message) {
        // Add user message to chat (this will also save to session)
        addMessage(message, true);

        // Add to input history
        addToInputHistory(message);

        // Show typing indicator
        showTypingIndicator();

        // Send message to Android
        window.AndroidInterface.sendMessage(message);
    }

    // Make this function available globally so Android can call it
    window.receiveMessageFromAndroid = receiveMessageFromAndroid;

    // Event listeners
    sendButton.addEventListener('click', function() {
        const message = messageInput.value.trim();
        if (message) {
            sendMessageToAndroid(message);
            messageInput.value = '';
        }
    });

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const message = messageInput.value.trim();
            if (message) {
                sendMessageToAndroid(message);
                messageInput.value = '';
            }
        }
    });

    // Input history button event listener
    inputHistoryButton.addEventListener('click', function(e) {
        e.stopPropagation();
        showInputHistoryPopup();
    });

    // History button event listener
    historyButton.addEventListener('click', function(e) {
        e.stopPropagation();
        showSessionPanel();
    });

    // Close panel button event listener
    closePanel.addEventListener('click', function(e) {
        e.stopPropagation();
        hideSessionPanel();
    });

    // Clear all sessions button
    clearAllBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        clearAllSessions();
    });

    // Input history close button event listener
    closeInputHistory.addEventListener('click', function(e) {
        e.stopPropagation();
        hideInputHistoryPopup();
    });

    // Close panel when clicking outside
    document.addEventListener('click', function(e) {
        if (sessionPanel.style.display === 'flex' &&
            !sessionPanel.contains(e.target) &&
            e.target !== historyButton) {
            hideSessionPanel();
        }
        
        if (inputHistoryPopup.style.display === 'block' &&
            !inputHistoryPopup.contains(e.target) &&
            e.target !== inputHistoryButton) {
            hideInputHistoryPopup();
        }
    });

    // Function to escape HTML for safe insertion
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Function to open original URL
    function openOriginalUrl(url) {
        if (window.AndroidInterface && typeof window.AndroidInterface.openUrlInNewTab === 'function') {
            window.AndroidInterface.openUrlInNewTab(url);
        } else {
            // Fallback - try to open in current window
            window.open(url, '_blank');
        }
    }

    // Make functions available globally for HTML onclick handlers
    window.switchToSession = switchToSession;
    window.deleteSession = deleteSession;
    window.hideSessionPanel = hideSessionPanel;
    window.openOriginalUrl = openOriginalUrl;

    // Initial setup - initialize sessions and focus on input
    initializeSessions();
    messageInput.focus();
</script>
</body>
</html>
